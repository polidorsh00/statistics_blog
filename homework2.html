<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homework 2 - Cybersecurity Statistics Blog</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #777;
            padding: 8px 12px;
            text-align: center;
        }
        th {
            background-color: #800020;
            color: white;
        }
        code {
            display: block;
            background-color: #1e1e1e;
            color: #dcdcdc;
            padding: 10px;
            border-radius: 6px;
            margin: 15px 0;
            font-family: "Courier New", monospace;
            white-space: pre; /* preserve newlines and indentation */
            overflow-x: auto;  /* allow horizontal scroll for long lines */
            tab-size: 4;       /* make tabs render with sensible width */
        }
    </style>
</head>
<body>
    <header>
        <h1>Homework 2</h1>
        <p>Cybersecurity Statistics Blog</p>
    </header>
    <main>
        <h2>Explain the concept of dataset and distribution</h2>
        <p>
            A <strong>dataset</strong> is a structured collection of data, typically organized in tables made of
            rows and columns. Each row represents a single observation (or record), while each column represents
            a variable (or attribute) describing the data. Datasets are fundamental for any kind of statistical
            analysis, as they provide the raw material from which we can extract insights.
        </p>
        <p>
            A <strong>distribution</strong> describes how the values of a variable are spread or dispersed across
            possible outcomes. It allows us to understand the frequency or probability of occurrence for each
            value (in discrete cases) or interval (in continuous cases). In practice, distributions help identify
            central tendencies, variability, and anomalies in data.
        </p>

        <h2>Example: Creating a simple dataset in Access</h2>
        <p>
            Let's imagine we want to analyze login attempts to a secure server. We create a table named
            <code>LoginAttempts</code> with three variables:
        </p>

        <ul>
            <li><strong>UserID</strong> – identifier of the user</li>
            <li><strong>LoginHour</strong> – hour of the login (0–23)</li>
            <li><strong>Success</strong> – whether the login was successful (1) or failed (0)</li>
        </ul>

        <h3>SQL commands to create the table</h3>
        <code>
CREATE TABLE LoginAttempts (
    UserID TEXT(10),
    LoginHour INTEGER,
    Success INTEGER
);
        </code>

        <h3>Insert sample data</h3>
        <code>
INSERT INTO LoginAttempts (UserID, LoginHour, Success) VALUES
('U01', 8, 1),
('U02', 9, 0),
('U03', 9, 1),
('U01', 10, 1),
('U02', 10, 0),
('U04', 8, 1),
('U03', 11, 1),
('U01', 11, 0);
        </code>

        <h3>Resulting dataset</h3>
        <table>
            <tr><th>UserID</th><th>LoginHour</th><th>Success</th></tr>
            <tr><td>U01</td><td>8</td><td>1</td></tr>
            <tr><td>U02</td><td>9</td><td>0</td></tr>
            <tr><td>U03</td><td>9</td><td>1</td></tr>
            <tr><td>U01</td><td>10</td><td>1</td></tr>
            <tr><td>U02</td><td>10</td><td>0</td></tr>
            <tr><td>U04</td><td>8</td><td>1</td></tr>
            <tr><td>U03</td><td>11</td><td>1</td></tr>
            <tr><td>U01</td><td>11</td><td>0</td></tr>
        </table>

        <!-- Interactive distribution selector for LoginAttempts -->
        <section id="interactive-dist" style="margin-top:1rem;padding:0.75rem;border:1px solid rgba(0,0,0,0.06);border-radius:6px;">
            <h3>Compute distribution from LoginAttempts</h3>
            <p>Select one or more variables to group by and compute the count (frequency).</p>
            <form id="dist-form">
                <label><input type="checkbox" name="vars" value="UserID"> UserID</label>
                <label style="margin-left:12px;"><input type="checkbox" name="vars" value="LoginHour"> LoginHour</label>
                <label style="margin-left:12px;"><input type="checkbox" name="vars" value="Success" checked> Success</label>
                <button type="submit" style="margin-left:12px;">Compute</button>
            </form>

            <h4 style="margin-top:0.8rem;">SQL query</h4>
            <pre id="sql-query" style="white-space:pre-wrap;background:#1e1e1e;padding:10px;border-radius:6px;color:#dcdcdc;font-family: 'Courier New', monospace;margin:15px 0;overflow:auto;">
            </pre>

            <h4>Result</h4>
            <div id="dist-table-wrap"></div>
        </section>

        


        <h2>Letter distribution from literature</h2>
        <p>Choose a public-domain piece of literature below, load the text and compute the distribution of letters (A–Z). The page will show counts and a simple bar chart.</p>

        <label for="literature-select">Select text:</label>
        <select id="literature-select">
            <option value="holden" selected>Giovane Holden (Italian)</option>
            <option value="alice">Alice's Adventures in Wonderland (English)</option>
            <option value="wuthering">Cime Tempestose (Italian)</option>
        </select>
        <button id="load-lit">Load text</button>

        <p>
            <label for="lit-text">Text (you can edit):</label>
        </p>
    <textarea id="lit-text" rows="8" style="width:100%;background:rgba(0,0,0,0.2);padding:0.5rem;border-radius:6px;color:#fff;"></textarea>
        <div style="margin-top:0.5rem;">
            <button id="compute-lit">Compute letter distribution</button>
        </div>

        <h4>Result</h4>
        <div id="literature-output">
            <div id="literature-chart" style="margin-top:0.5rem;"></div>
        </div>
    <!-- Caesar cipher UI -->
    <h3>Caesar cipher</h3>
    <p>Here we apply a Caesar cipher to the loaded text: the <em>Encrypt</em> button shifts every letter by the selected number of positions (shift); the <em>Auto-decode</em> button attempts to recover the original text when the shift is unknown by using frequency analysis — comparing the ciphertext's letter distribution with the expected distribution for the chosen language (Italian/English).</p>
        <div style="display:flex;gap:8px;align-items:center;margin-top:0.4rem;">
            <label for="caesar-shift">Shift (0-25):</label>
            <input id="caesar-shift" type="number" min="0" max="25" value="3" style="width:80px;padding:4px;">
            <button id="encrypt-btn">Encrypt (apply Caesar)</button>
        </div>

        <p style="margin-top:0.6rem;">Encrypted text:</p>
        <pre id="encrypted-output" style="white-space:pre-wrap;background:rgba(0,0,0,0.18);padding:0.6rem;border-radius:6px;color:#fff;min-height:2.2rem;"></pre>

        <div style="margin-top:0.5rem;display:flex;gap:8px;align-items:center;">
            <label for="lang-select">Language for decoding:</label>
            <select id="lang-select">
                <option value="italian">Italian</option>
                <option value="english">English</option>
            </select>
            <button id="auto-decode-btn">Auto-decode</button>
        </div>

        <p style="margin-top:0.4rem;">Decoded (best guess):</p>
        <pre id="decrypted-output" style="white-space:pre-wrap;background:rgba(0,0,0,0.12);padding:0.6rem;border-radius:6px;color:#fff;min-height:2.2rem;"></pre>

    <h4 style="margin-top:0.6rem;">Reference distribution for selected language</h4>
    <div id="language-chart" style="margin-top:0.5rem;display:none;"></div>


        <section id="decrypt-explanation" style="margin-top:1rem;padding:0.75rem;border-left:4px solid #800020;background:rgba(0,0,0,0.03);border-radius:6px;">
            <h3>Automatic decryption algorithm explanation</h3>
            <p style="margin-top:0.2rem;">
                The algorithm used to <strong>auto-decode</strong> text encrypted with a Caesar cipher is based on
                letter-frequency analysis (A–Z). The main steps are:
            </p>
            <ol>
                <li>Compute the observed frequency of letters in the ciphertext (ignoring non-alphabetic characters).</li>
                <li>For each possible shift (0–25), rotate the observed distribution by that shift and compare it to the
                    reference distribution for the selected language (Italian or English).</li>
                <li>Measure the distance between the rotated distribution and the reference distribution (for example using
                    sum-of-squares or a chi-square-like statistic).</li>
                <li>Select the shift that minimizes the distance — applying the inverse of that shift yields the most likely
                    plaintext candidate.</li>
            </ol>
            <p style="margin-top:0.2rem;">
                Note: this method works best with sufficiently long texts (short texts yield noisy frequency estimates)
                and assumes a simple Caesar encryption (uniform rotation of letters). It does not fix punctuation or
                recover missing words.
            </p>
        </section>

        <p><a href="index.html">← Back to Home</a></p>
    </main>
    <footer>
        &copy; 2025 Alessandro Polidori
    </footer>
    <script>
        // Excerpts for works (public-domain where possible). NOTE: Giovane Holden is copyrighted;
        // we include only a short allowed snippet here. If you want a longer Holden passage,
        // please paste it into the textarea (or confirm you own the rights).
        const LITERATURE = {
            holden: `Se davvero avete voglia di sentire questa storia, magari vorrete sapere prima di tutto dove sono nato
e com\u00E8 stata la mia infanzia schifa e che cosa facevano i miei genitori e compagnia bella prima che
arrivassi io, e tutte quelle baggianate alla David Copperfield, ma a me non mi va proprio di
parlarne. Primo, quella roba mi secca, e secondo, ai miei genitori gli verrebbero un paio d'infarti per
uno se dicessi qualcosa di troppo personale sul loro conto. Sono tremendamente suscettibili su
queste cose, soprattutto mio padre. Carini e tutto quanto - chi lo nega - ma anche maledettamente
suscettibili. D'altronde, non ho nessuna voglia di mettermi a raccontare tutta la mia dannata autobiografia e compagnia bella. Vi racconter\u00F2 soltanto le cose da matti che mi sono capitate verso
Natale, prima di ridurmi cos\u00ED a terra da dovermene venire qui a grattarmi la pancia. Niente di pi\u00F9 di
quel che ho raccontato a D. B., con tutto che lui \u00E8 mio fratello e quel che segue. Sta a Hollywood,
lui. Non \u00E8 poi tanto lontano da questo lurido buco, e viene qui a trovarmi praticamente ogni fine
settimana. Mi accompagner\u00E0 a casa in macchina quando ci andr\u00F2 il mese prossimo, chi sa. Ha
appena preso una Jaguar. Uno di quei gingilli inglesi che arrivano sui trecento all'ora. Gli \u00E8 costata
uno scherzetto come quattromila sacchi o gi\u00F9 di l\u00ED. \u00C8 pieno di soldi, adesso, Mica come prima. Era
soltanto uno scrittore in piena regola, quando stava a casa. Ha scritto quel formidabile libro di
racconti, Il pesciolino nascosto, se per caso non l'avete mai sentito nominare. Il pi\u00F9 bello di quei
racconti era Il pesciolino nascosto. Parlava di quel ragazzino che non voleva far vedere a nessuno il
suo pesciolino rosso perch\u00E9 l'aveva comprato coi soldi suoi. Una cosa da lasciarti secco. Ora sta a
Hollywood, D. B., a sputtanarsi. Se c'\u00E8 una cosa che odio sono i film. Non me li nominate
nemmeno.
Voglio cominciare il mio racconto dal giorno che lasciai l'Istituto Pencey. L'Istituto Pencey \u00E8 quella
scuola che sta ad Agerstown in Pennsylvania. Probabile che ne abbiate sentito parlare. Probabile
che abbiate visto gli annunci pubblicitari, se non altro. Si fanno la pubblicit\u00E0 su un migliaio di
riviste, e c'\u00E8 sempre un tipo gagliardo a cavallo che salta una siepe. Come se a Pencey non si facesse
altro che giocare a polo tutto il tempo. Io di cavalli non ne ho visto neanche uno, n\u00E9 l\u00EC, n\u00E9 nei
dintorni. E sotto quel tipo a cavallo c'\u00E8 sempre scritto: Dal 1888 noi forgiamo una splendida
giovent\u00F9 dalle idee chiare. Buono per i merli. A Pencey non forgiano un accidente, tale e quale
come nelle altre scuole. E io laggi\u00F9 non ho conosciuto nessuno che fosse splendido e dalle idee
chiare e via discorrendo. Forse due tipi. Seppure. E probabilmente erano gi\u00E0 cos\u00EC prima di andare a
Pencey.
Ad ogni modo, era il sabato della partita di rugby col Saxon Hall. La partita col Saxon Hall, a
Pencey, era un affare di stato. Era l'ultima partita dell'anno e pensavano che dovevi per lo meno
ammazzarti se il vecchio Pencey non vinceva. Mi ricordo che verso le tre di quel pomeriggio me ne
stavo l\u00E0 sul cocuzzolo di Thomsen Hill, proprio vicino a quel cannone scassato che aveva fatto la
Guerra d\u00ED Secessione e tutto quanto. Di l\u00EC si vedeva tutto il campo, e si vedevano le due squadre che
se le sonavano in lungo e in largo. Non si vedeva tanto bene la tribuna, ma si sentivano gli urli da
maledetti, cupi e tremendi dalla parte del Pencey, perch\u00E9 tolto che mancavo io c'era la scuola al
completo, e fiacchi e isolati dalla parte del Saxon Hall, perch\u00E9 la squadra ospite non portava quasi
mai molta gente.`,
            alice: `Alice was beginning to get very tired of sitting by her sister on the bank, and of having nothing to do: once or twice she had peeped into the book her sister was reading, but it had no pictures or conversations in it.

"And what is the use of a book," thought Alice, "without pictures or conversation?"

So she was considering in her own mind (as well as she could, for the hot day made her feel very sleepy and stupid), whether the pleasure of making a daisy-chain would be worth the trouble of getting up and picking the daisies, when suddenly a White Rabbit with pink eyes ran close by her.

There was nothing so VERY remarkable in that; nor did Alice think it so VERY much out of the way to hear the Rabbit say to itself, "Oh dear! Oh dear! I shall be late!" (when she thought it over afterwards, it occurred to her that she ought to have wondered at this, but at the time it all seemed quite natural); but when the Rabbit actually took a watch out of its waistcoat-pocket, and looked at it, and then hurried on, Alice started to her feet, for it flashed across her mind that she had never before seen a rabbit with either a waistcoat-pocket, or a watch to take out of it, and burning with curiosity, she ran across the field after it, and fortunately was just in time to see it pop down a large rabbit-hole under the hedge.

In another moment down went Alice after it, never once considering how in the world she was to get out again.

The rabbit-hole went straight on like a tunnel for some way, and then dipped suddenly down, so suddenly that Alice had not a moment to think about stopping herself before she found herself falling down what seemed a very deep well. Either the well was very deep, or she fell very slowly, for she had plenty of time as she went down to look about her and to wonder what was going to happen next. First, she tried to make out what she could see down there; that is, she looked down, but it was too dark to see anything; then she looked at the sides of the well, and noticed that they were filled with cupboards and book-shelves; here and there she saw maps and pictures hung upon pegs. She took down a jar from one of the shelves as she passed; it was labelled "ORANGE MARMALADE", but to her great disappointment it was empty; she did not like to drop the jar for fear of killing somebody, so managed to put it into one of the cupboards as she fell past it.

Down, down, down. Would the fall never come to an end! "I wonder how many miles I've fallen by this time?" she said aloud. "I must be getting somewhere near the centre of the earth. Let me see: that would be four thousand miles down, I think—" (for, you see, Alice had learnt several things of this sort in her lessons in the schoolroom, and though this was not a VERY good opportunity for showing off her knowledge, as there was no one to listen to her, still it was good practice to say it over), "—yes, that's about the right distance—but then I wonder what Latitude or Longitude I've got to?" (Alice had no idea what Latitude or Longitude were, but thought they were nice grand words to say.).

Presently she began again. "I wonder if I shall fall right through the earth! How funny it'll seem to come out among the people that walk with their heads downwards! The Antipathies, I think—" (she was rather glad there WAS no one listening, this time, as it didn't sound at all the right word), "—but I shall have to ask them what the name of the country is, you know. Please, Ma'am, is this New Zealand or Australia?" (and she tried to curtsey as she spoke—fancy curtseying as you're falling through the air! Do you think you could manage it?).

"And what an ignorant little girl she'll think me for asking! No, it'll never do to ask: perhaps I shall see it written up somewhere."

Down, down, down. There was nothing else to do, so Alice soon began talking again. `,
            wuthering: `1801. - Sono appena ritornato da una visita al mio padrone di casa, il
solo vicino col quale avrò a che fare. Questa è indubbiamente una bella
contrada. Credo che in tutta l'Inghilterra non avrei potuto scegliermi un
altro posto più lontano dal frastuono della società. È il paradiso del
perfetto misantropo; e il signor Heathcliff ed io siamo fatti apposta per una
simile desolazione. Un uomo veramente singolare! Non immaginava certo
quale viva simpatia sentissi per lui quando vidi i suoi occhi neri ritrarsi
così sospettosamente sotto le ciglia al mio avanzare a cavallo, e le sue
mani rifugiarsi ancor più addentro nel panciotto, con gelosa risolutezza,
all'annuncio del mio nome.
«Il signor Heathcliff» dissi.
Un inchino del capo fu la risposta.
«Il signor Lockwood, il vostro nuovo affittuario, signore. Mi faccio
l'onore di presentarmi a voi il più sollecitamente possibile, subito dopo il
mio arrivo, voglio esprimervi la speranza che ho di non esser stato troppo
importuno con la mia insistenza nel chiedervi di poter abitare Thrushcross
Grange. Proprio ieri ho saputo che voi avevate l'intenzione...»
«Thrushcross Grange è mia proprietà, signore,» mi interruppe,
aggrottando le ciglia. «Non permetterei mai a nessuno di importunarmi,
poiché sta solo a me d'impedirlo... Entrate!»
Quell'«entrate» fu pronunciato a denti stretti ed esprimeva un sentimento
ben diverso, a esempio, «Andatevene al diavolo!»; perfino il cancello al
quale si era appoggiato non diede il minimo segno di consenso a quella
parola, e credo che fu proprio tale circostanza a farmi accettare l'invito:
sentii interesse per quell'uomo che sembrava esageratamente riservato,
ancora più di quanto lo fossi io.
Quando vide che il mio cavallo già si spingeva col petto contro la sbarra,
allora, finalmente, levò una mano per togliere la catena, e precedendomi 
piuttosto di malavoglia per il vialetto, entrò nella corte e gridò: «Giuseppe,
prendi il cavallo del signor Lockwood e portaci su del vino.»
«Questa dev'esser tutta la sua servitù, m'immagino,» fu la riflessione
suggeritami da quell'ordine. «Nessuna meraviglia se l'erba cresce fra le
pietre e il solo bestiame pensa a cimare le siepi.»
Giuseppe era un uomo in età, anzi, un vecchio; forse molto vecchio,
quantunque sano e vigoroso. «Che il Signore ci aiuti!» monologò
sottovoce, con mal celato dispetto, mentre prendeva le briglie del mio
cavallo, e mi guardava con un viso così arcigno che conclusi,
caritatevolmente, che avesse bisogno dell'aiuto divino per digerire il
pranzo, e che la sua pia invocazione non dovesse avere quindi alcun
riferimento al mio inaspettato arrivo.
Wuthering Heights è il nome della residenza di Heathcliff; «Wuthering»
è un aggettivo molto espressivo, proprio di quella provincia, e descrive il
tumulto atmosferico al quale trovasi esposta durante la bufera. Debbono
avere aria pura e mossa lassù in ogni momento! Ci si può immaginare la
violenza del vento del nord quando soffia al di sopra della siepe,
dall'esagerata inclinazione di alcuni miseri abeti che stanno al limitare
della casa e da uno sparuto filare di squallidi ceppi di roveti che tendono le
braccia da un sol verso come ad impetrare l'elemosina dal sole.
Fortunatamente, l'architetto che eresse quella casa, ebbe l'avvertenza di
costruire un edificio solido: le strette finestre sono bene incastrate nel
muro, e gli angoli sono difesi da larghe pietre sporgenti. Prima di passare
la soglia mi soffermai ad ammirare i grotteschi profusi sulla facciata,
specialmente come decorazione della porta principale, sopra la quale tra
uno scialo di grifoni e di putti nudi, scoprii la data «1500», ed il nome
«Hareton Earnshaw». Avrei voluto fare qualche commento, o chiedere la
breve storia del luogo allo scontroso proprietario, ma il modo con cui
questi si teneva sulla porta, sembrava esigere o un'immediata entrata, o una
ancor più rapida partenza, ed io non desideravo accrescere la sua
impazienza prima di visitare quei penetrali.
Con un passo ci trovammo nelle stanze di famiglia (non essendovi
anticamere nè corridoi d'ingresso), in questo paese denominate per
eccellenza «la casa». Generalmente essa comprende la cucina e il salotto,
ma credo che a Wuthering Heights la cucina sia relegata altrove: da una
remota distanza infatti mi giunse uno schiamazzar di voci ed il tintinnare
di utensili di cucina, e lì sull'enorme camino non mi fu dato di scorgere
niente che somigliasse ad arrosto o a bollito, e neppure mi colpì il luccichìo 
di casseruole di rame e di schiumarole di stagno sulle pareti.`,
        };

        function computeLetterCounts(text) {
            const A = 'A'.charCodeAt(0);
            const counts = {};
            for (let i = 0; i < 26; i++) counts[String.fromCharCode(A + i)] = 0;
            for (const ch of (text || '').toUpperCase()) {
                const code = ch.charCodeAt(0);
                if (code >= A && code < A + 26) counts[String.fromCharCode(code)]++;
            }
            return counts;
        }

        function renderBarChart(counts, containerId, options = {}) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';
            const entries = Object.entries(counts);
            const max = Math.max(...entries.map(e => e[1]), 1);
            const wrap = document.createElement('div');
            wrap.style.display = 'flex';
            wrap.style.flexDirection = 'column';
            wrap.style.gap = '6px';

            // if showPercent is requested, compute total for percentage calculation
            const showPercent = options.showPercent === true;
            let total = 0;
            if (showPercent) total = entries.reduce((s, e) => s + Number(e[1] || 0), 0) || 1;

            entries.forEach(([letter, value]) => {
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.alignItems = 'center';
                const label = document.createElement('div');
                label.textContent = letter;
                label.style.width = '28px';
                label.style.color = '#111';
                label.style.fontWeight = '600';
                const barWrap = document.createElement('div');
                barWrap.style.flex = '1';
                barWrap.style.background = 'rgba(0,0,0,0.05)';
                barWrap.style.borderRadius = '4px';
                barWrap.style.margin = '0 8px';
                const bar = document.createElement('div');
                bar.style.height = '18px';
                bar.style.width = `${(value / max) * 100}%`;
                bar.style.background = '#800020';
                bar.style.borderRadius = '4px';
                barWrap.appendChild(bar);
                const val = document.createElement('div');
                if (showPercent) {
                    const pct = (Number(value) / total) * 100;
                    val.textContent = `${pct.toFixed(1)}%`;
                } else {
                    val.textContent = value;
                }
                val.style.width = '48px';
                val.style.textAlign = 'right';
                row.appendChild(label);
                row.appendChild(barWrap);
                row.appendChild(val);
                wrap.appendChild(row);
            });

            container.appendChild(wrap);
        }

        document.getElementById('load-lit').addEventListener('click', () => {
            const key = document.getElementById('literature-select').value;
            document.getElementById('lit-text').value = LITERATURE[key] || '';
        });

        document.getElementById('compute-lit').addEventListener('click', () => {
            const text = document.getElementById('lit-text').value || '';
            const counts = computeLetterCounts(text);
            renderBarChart(counts, 'literature-chart');
        });

        // ------------------ Caesar cipher & automatic decoding ------------------
        function caesarShiftChar(ch, shift) {
            const A = 'A'.charCodeAt(0);
            const a = 'a'.charCodeAt(0);
            const code = ch.charCodeAt(0);
            if (code >= A && code < A + 26) {
                return String.fromCharCode(((code - A + shift) % 26 + 26) % 26 + A);
            } else if (code >= a && code < a + 26) {
                return String.fromCharCode(((code - a + shift) % 26 + 26) % 26 + a);
            }
            return ch;
        }

        function caesarEncrypt(text, shift) {
            return Array.from(text).map(ch => caesarShiftChar(ch, shift)).join('');
        }

        function normalizeFreqs(freqs) {
            const total = Object.values(freqs).reduce((a,b) => a + b, 0) || 1;
            const out = {};
            Object.keys(freqs).forEach(k => out[k] = freqs[k] / total);
            return out;
        }

        function rotateFreqs(freqs, shift) {
            const A = 'A'.charCodeAt(0);
            const out = {};
            for (let i = 0; i < 26; i++) out[String.fromCharCode(A + i)] = 0;
            Object.keys(freqs).forEach(k => {
                const idx = k.charCodeAt(0) - A;
                const newIdx = (idx + shift + 26) % 26;
                out[String.fromCharCode(A + newIdx)] = freqs[k];
            });
            return out;
        }

        function chiSquareDistance(obs, exp) {
            const eps = 1e-9;
            let sum = 0;
            Object.keys(exp).forEach(k => {
                const e = exp[k] || 0;
                const o = obs[k] || 0;
                sum += ((o - e) * (o - e)) / (e + eps);
            });
            return sum;
        }

        // Language reference frequencies (percentages normalized later)
        const REF_FREQ = {
            italian: { A:11.7,B:0.9,C:4.5,D:3.7,E:11.7,F:1.1,G:1.6,H:0.6,I:10.1,J:0.01,K:0.01,L:6.5,M:2.5,N:6.8,O:9.8,P:3,Q:0.5,R:6.3,S:4.9,T:5.6,U:3,V:2,W:0.03,X:0.01,Y:0.02,Z:1.1 },
            english: { A:8.17,B:1.49,C:2.78,D:4.25,E:12.7,F:2.23,G:2.02,H:6.09,I:6.97,J:0.15,K:0.77,L:4.03,M:2.41,N:6.75,O:7.51,P:1.93,Q:0.1,R:5.99,S:6.33,T:9.06,U:2.76,V:0.98,W:2.36,X:0.15,Y:1.97,Z:0.07 }
        };

        // normalize reference
        Object.keys(REF_FREQ).forEach(lang => REF_FREQ[lang] = normalizeFreqs(REF_FREQ[lang]));

        document.getElementById('encrypt-btn').addEventListener('click', () => {
            const shift = Number(document.getElementById('caesar-shift').value) || 0;
            const text = document.getElementById('lit-text').value || '';
            const encrypted = caesarEncrypt(text, shift);
            document.getElementById('encrypted-output').textContent = encrypted;
        });

        document.getElementById('auto-decode-btn').addEventListener('click', () => {
            // use encrypted-output if present, otherwise current textarea
            let cipher = document.getElementById('encrypted-output').textContent || document.getElementById('lit-text').value || '';
            if (!cipher) return;
            // observed frequencies from cipher
            const obsCounts = computeLetterCounts(cipher);
            const obsFreq = normalizeFreqs(obsCounts);
            const lang = document.getElementById('lang-select').value || 'italian';
            const ref = REF_FREQ[lang];
            let best = {shift:0,score:Infinity};
            for (let s = 0; s < 26; s++) {
                // rotate observed by -s to align with reference (equivalent)
                const rotated = rotateFreqs(obsFreq, -s);
                const score = chiSquareDistance(rotated, ref);
                if (score < best.score) best = {shift: s, score};
            }
            // best.shift is the shift that when applied to ciphertext (i.e., shifting letters by -best.shift) returns plaintext.
            const guessedShift = (26 - best.shift) % 26; // convert to decrypt shift
            const decrypted = caesarEncrypt(cipher, guessedShift);
            document.getElementById('decrypted-output').textContent = `Guessed shift: ${guessedShift}\n\n` + decrypted;
            // show reference chart for the language used
            renderLanguageChart(lang);
        });

        // render language reference chart
        function renderLanguageChart(lang) {
            const freq = REF_FREQ[lang] || REF_FREQ['italian'];
            // convert normalized frequencies to percentages for display
            const counts = {};
            Object.keys(freq).forEach(k => counts[k] = freq[k] * 100);
            renderBarChart(counts, 'language-chart', { showPercent: true });
            const el = document.getElementById('language-chart');
            if (el) el.style.display = '';
        }

        // initial render and on language change
        document.getElementById('lang-select').addEventListener('change', (e) => renderLanguageChart(e.target.value));


        // ------------------ Interactive distribution for LoginAttempts ------------------
        function readLoginAttemptsTable() {
            // choose the first table in the main area (the sample dataset)
            const table = document.querySelector('main table');
            if (!table) return [];
            // find header cells: first tr that contains th
            let headerCells = [];
            const allTrs = Array.from(table.querySelectorAll('tr'));
            for (const tr of allTrs) {
                const ths = Array.from(tr.querySelectorAll('th'));
                if (ths.length) { headerCells = ths.map(h => h.textContent.trim()); break; }
            }
            if (!headerCells.length) {
                // fallback to default headers
                headerCells = ['UserID','LoginHour','Success'];
            }
            // data rows: only tr elements that contain td cells
            const dataTrs = allTrs.filter(tr => tr.querySelectorAll('td').length > 0);
            return dataTrs.map(r => {
                const cells = Array.from(r.querySelectorAll('td'));
                const obj = {};
                cells.forEach((c, i) => {
                    const key = headerCells[i] || `col${i}`;
                    let val = c.textContent.trim();
                    if (val !== '' && !isNaN(val)) val = Number(val);
                    obj[key] = val;
                });
                return obj;
            });
        }

        function groupCounts(data, groupKeys) {
            const map = new Map();
            data.forEach(row => {
                const keyObj = {};
                groupKeys.forEach(k => keyObj[k] = row[k]);
                const key = JSON.stringify(keyObj);
                map.set(key, (map.get(key) || 0) + 1);
            });
            const result = [];
            for (const [k,v] of map.entries()) {
                const obj = JSON.parse(k);
                obj['Frequency'] = v;
                result.push(obj);
            }
            return result;
        }

        function generateSQL(groupKeys) {
            if (!groupKeys.length) return '-- Please select at least one variable to group by.';
            const cols = groupKeys.map(k => `"${k}"`).join(', ');
            return `SELECT ${cols}, COUNT(*) AS Frequency\nFROM LoginAttempts\nGROUP BY ${cols};`;
        }

        function renderDistResult(rows, containerId='dist-table-wrap', groupKeys=[]) {
            const wrap = document.getElementById(containerId);
            wrap.innerHTML = '';
            if (!rows.length) { wrap.textContent = 'No results'; return; }
            const table = document.createElement('table');
            // ensure same visual style as static tables
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.marginTop = '0.5rem';
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            // Build headers using selected groupKeys in order, then Frequency
            const headers = (groupKeys && groupKeys.length) ? groupKeys.concat(['Frequency']) : Object.keys(rows[0]);
            headers.forEach(k => {
                const th = document.createElement('th'); th.textContent = k;
                th.style.border = '1px solid #777';
                th.style.padding = '8px 12px';
                th.style.backgroundColor = '#800020';
                th.style.color = '#fff';
                th.style.textAlign = 'center';
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            const tbody = document.createElement('tbody');
            rows.forEach(r => {
                const tr = document.createElement('tr');
                // ensure values follow the headers order
                const rowValues = headers.map(h => r[h] !== undefined ? r[h] : '');
                rowValues.forEach(v => { const td = document.createElement('td'); td.textContent = v; td.style.border = '1px solid #777'; td.style.padding = '8px 12px'; td.style.textAlign = 'center'; tr.appendChild(td); });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            wrap.appendChild(table);
        }

        document.getElementById('dist-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const groupKeys = formData.getAll('vars');
            const sql = generateSQL(groupKeys);
            document.getElementById('sql-query').textContent = sql;
            if (!groupKeys.length) {
                document.getElementById('dist-table-wrap').textContent = 'Please select at least one variable.';
                return;
            }
            const data = readLoginAttemptsTable();
            const result = groupCounts(data, groupKeys);
            renderDistResult(result, 'dist-table-wrap', groupKeys);
        });

        // run default on load (compute with defaults checked)
        window.addEventListener('load', () => {
            // compute distribution for LoginAttempts (dist-form)
            const evt = new Event('submit');
            document.getElementById('dist-form').dispatchEvent(evt);
            // set selected literature as default loaded text and render letter chart
            const sel = document.getElementById('literature-select');
            const key = sel ? sel.value : 'alice';
            document.getElementById('lit-text').value = LITERATURE[key] || '';
            document.getElementById('compute-lit').click();
            // simulate Encrypt then Auto-decode so the page appears already processed
            // small timeout to ensure compute-lit finished updating textarea/chart
            setTimeout(() => {
                const encBtn = document.getElementById('encrypt-btn');
                if (encBtn) encBtn.click();
                // another short timeout to ensure encrypted text populated before auto-decode
                setTimeout(() => {
                    const autoBtn = document.getElementById('auto-decode-btn');
                    if (autoBtn) autoBtn.click();
                }, 120);
            }, 120);
        });
    </script>
</body>
</html>
